# Lab2 实验报告

Author: *刘佳隆*

Student ID: *518010910009*

Email: *<liujl01@sjtu.edu.cn>*

## 思考题 5

阅读 Arm Architecture Reference Manual，思考要在操作系统中支持写时拷贝（Copy-on-Write，CoW）需要配置页表描述符的哪个/哪些字段，并在发生页错误时如何处理。（在完成第三部分后，你也可以阅读页错误处理的相关代码，观察 ChCore 是如何支持 Cow 的）.

支持写时拷贝需要配置页表描述符中的如下字段：

- Shareable bit (SH): 表示该内存区域是否可被多个处理器核心共享。对于CoW，应修改该位，使映射到同一物理内存的多个虚拟地址空间可以共享该内存区域。
- Access Permissions (AP): 页表项中的访问权限字段，用于控制对内存区域的读写权限。在CoW场景下，初始时所有共享页面应该被配置为只读，当任何进程尝试修改共享页面时，会触发页错误异常。
- Execute Never (XN): 根据安全需求，可能还需要设置“XN”位来禁止代码执行权限。

当发生 COW 页错误时，操作系统需要处理如下步骤：

1. 通过页错误异常处理程序，获取引发页错误的虚拟地址。
2. 根据虚拟地址，查找页表，获取对应的页表项。
3. 分配一个新的物理页，并将原物理页的内容拷贝到新的物理页中。
4. 更新页表项，将新的物理页映射到当前进程的虚拟地址空间中。
5. 刷新 TLB 缓存，使新的页表项生效。
6. 重新执行引发页错误的指令。

ChCore 当检测到 permission fault 时，会调用 `handle_perm_fault` 函数处理。在对权限位进行检查，发现 VMR 为 COW 时，会调用 `do_cow` 函数进行处理。在 `do_cow` 函数中进行预处理，而后调用 `__do_general_cow` 函数，完成分配物理页、在 VMR 中记录、拷贝数据、更新 pte、刷新 TLB 等操作。

## 思考题 6

为了简单起见，在 ChCore 实验 Lab1 中没有为内核页表使用细粒度的映射，而是直接沿用了启动时的粗粒度页表，请思考这样做有什么问题。

1. 内存利用率：粗粒度页表映射可能导致内存分配不够灵活，因为必须以大页的整数倍进行分配，可能会导致较小内存区域的浪费，即存在内部碎片。
2. 粒度控制不足：对于更细致的权限控制或者不同的内存属性（如Cache属性、写保护等），细粒度映射提供了更为精确的控制手段。
